<div class="results-header">
    <h1 class="results-title">üé≠ Final Stories</h1>
    <p class="results-subtitle">The collaborative tales have been told! Cast your votes below.</p>
</div>

<div class="stories-container">
    {{#each stories}}
    <div class="story-card" data-story-index="{{@index}}">
        <div class="story-header">
            <div class="story-number">Story #{{add @index 1}}</div>
        </div>

        <div class="contributors-section">
            <span class="contributors-label">‚ú® Contributors:</span>
            <div class="contributors-list">
                {{#each this.authors}}
                <span class="contributor-badge">{{this}}</span>{{#unless @last}} {{/unless}}
                {{/each}}
            </div>
        </div>

        {{#if ../keepHistory}}
        <div class="history-controls" data-controls-for="{{@index}}">
            <button class="hist-btn hist-prev" title="View earlier turn">
                <span class="hist-icon">‚¨ÖÔ∏è</span>
            </button>
            <span class="hist-status">Final ({{this.authors.length}} / {{this.authors.length}} turns)</span>
            <button class="hist-btn hist-next" title="View later turn" {{#unless
                this.history.length}}disabled{{/unless}}>
                <span class="hist-icon">‚û°Ô∏è</span>
            </button>
        </div>
        {{/if}}

        <div class="story-content-wrapper">
            <div class="resultsBox story-markdown story-content">{{{markdown this.content}}}</div>
        </div>

        <div class="vote-section" data-story="{{@index}}">
            <div class="vote-buttons">
                <button class="vote-btn btn-like">
                    <span class="vote-emoji">üëç</span>
                    <span class="vote-text">Love it!</span>
                </button>
                <button class="vote-btn btn-dislike">
                    <span class="vote-emoji">üëé</span>
                    <span class="vote-text">Not for me</span>
                </button>
            </div>

            <div class="vote-results">
                <div class="vote-group likes-group">
                    <div class="vote-header">
                        <span class="vote-icon">üíö</span>
                        <span class="vote-label">Loves (<span class="likes-count">0</span>)</span>
                    </div>
                    <div class="vote-list likes-list"></div>
                </div>

                <div class="vote-group dislikes-group">
                    <div class="vote-header">
                        <span class="vote-icon">üíî</span>
                        <span class="vote-label">Not their cup of tea (<span class="dislikes-count">0</span>)</span>
                    </div>
                    <div class="vote-list dislikes-list"></div>
                </div>
            </div>

            <script type="application/json" class="story-votes">{{{JSONstringify (lookup ../votes @index)}}}</script>
        </div>

        {{#if ../keepHistory}}
        <script type="application/json" class="story-history">{{{JSONstringify this.history}}}</script>
        {{/if}}
    </div>
    {{/each}}
</div>

<div class="back-to-games">
    <a href="/games" class="back-btn">
        <span class="back-icon">üéÆ</span>
        <span class="back-text">Back to Games</span>
    </a>
</div>

{{#if keepHistory}}
<script>
    document.querySelectorAll('.story-card').forEach(storyEl => {
        const historyScript = storyEl.querySelector('.story-history');
        if (!historyScript) return;
        let history; try { history = JSON.parse(historyScript.textContent || '[]'); } catch (e) { history = []; }

        history.sort((a, b) => a.turn - b.turn);
        const contentEl = storyEl.querySelector('.story-content');

        if (!contentEl.dataset.finalHtml) {
            contentEl.dataset.finalHtml = contentEl.innerHTML;
        }

        const statusEl = storyEl.querySelector('.hist-status');
        const prevBtn = storyEl.querySelector('.hist-prev');
        const nextBtn = storyEl.querySelector('.hist-next');
        const total = history.length;
        let idx = total; // start at final

        function render() {
            if (idx === total) {
                statusEl.textContent = 'Final (' + total + ' / ' + total + ' turns)';
            } else {
                const h = history[idx];
                statusEl.textContent = 'After Turn ' + (h.turn + 1) + ' by ' + h.author + ' (' + (idx + 1) + ' / ' + total + ')';
            }
            prevBtn.disabled = (idx === 0);
            nextBtn.disabled = (idx === total);
            if (idx === total) {
                contentEl.innerHTML = contentEl.dataset.finalHtml;
            } else {
                contentEl.innerHTML = history[idx].html;
            }
        }
        if (total === 0) {
            // No intermediate history; disable both
            if (prevBtn) prevBtn.disabled = true;
            if (nextBtn) nextBtn.disabled = true;
        } else {
            prevBtn && prevBtn.addEventListener('click', () => { if (idx > 0) { idx--; render(); } });
            nextBtn && nextBtn.addEventListener('click', () => { if (idx < total) { idx++; render(); } });

            // Initialize button states
            render();
        }
    });
</script>
{{/if}}

<script src="/socket.io/socket.io.js"></script>
<script>
    (function () {
        const code = "{{code}}";
        const username = "{{username}}";
        const socket = io();
        socket.emit('join-room', code);

        // Wire buttons
        document.querySelectorAll('.vote-section').forEach(panel => {
            const storyIndex = parseInt(panel.getAttribute('data-story'), 10);
            const likeBtn = panel.querySelector('.btn-like');
            const dislikeBtn = panel.querySelector('.btn-dislike');
            const likesList = panel.querySelector('.likes-list');
            const dislikesList = panel.querySelector('.dislikes-list');
            const likesCount = panel.querySelector('.likes-count');
            const dislikesCount = panel.querySelector('.dislikes-count');
            // Load initial from embedded JSON
            const votesScript = panel.querySelector('.story-votes');
            let initial = { likes: [], dislikes: [] };
            if (votesScript) {
                try { initial = JSON.parse(votesScript.textContent || '{}'); } catch (e) { initial = { likes: [], dislikes: [] }; }
            }

            function updateLocal({ likes, dislikes }) {
                const L = likes || [];
                const D = dislikes || [];
                likesList.textContent = L.join(', ');
                dislikesList.textContent = D.join(', ');
                if (likesCount) likesCount.textContent = L.length;
                if (dislikesCount) dislikesCount.textContent = D.length;
            }

            // Initialize with server state
            updateLocal(initial);

            async function sendVote(voteType) {
                try {
                    const res = await fetch(`/games/story/${code}/results/vote`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, storyIndex, voteType })
                    });
                    if (!res.ok) return;
                    const data = await res.json();
                    if (data.storyIndex === storyIndex) updateLocal(data);
                } catch (e) { /* ignore */ }
            }

            likeBtn && likeBtn.addEventListener('click', () => sendVote('like'));
            dislikeBtn && dislikeBtn.addEventListener('click', () => sendVote('dislike'));

            socket.on('results-vote-update', (payload) => {
                if (!payload || payload.storyIndex !== storyIndex) return;
                updateLocal(payload);
            });
        });
    })();
</script>
