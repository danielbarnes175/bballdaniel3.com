<h1>Write Your Part</h1>

<p class="story-meta"><strong>Turn {{add turn 1}}</strong> of {{totalTurns}}</p>
<p class="story-meta">Story #{{storyIndex}}</p>
<p class="story-meta">Time Left: <span id="timer">{{timeLeft}}</span> seconds</p>

<form id="writeForm" action="/games/story/{{code}}/write" method="POST">
    <textarea class="story-textarea" name="content" rows="12" required>{{previousContent}}</textarea>
    <input type="hidden" name="code" value="{{code}}">
    <input type="hidden" name="turn" value="{{turn}}">
    <input type="hidden" name="username" value="{{username}}">
    <br>
</form>

<script>
    const easyMDE = new EasyMDE({
        toolbar: ["bold", "italic", "|", "preview"],
        status: ["lines", "words"],
        spellChecker: false,
        renderingConfig: {
            sanitizerFunction: (renderedHTML) => {
                return DOMPurify.sanitize(renderedHTML, {
                    ALLOWED_TAGS: ['b', 'i', 'strong', 'em', 'p', 'br', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'blockquote'],
                    ALLOWED_ATTR: []
                });
            }
        }
    });
    let time = {{ timeLeft }};
    const timerEl = document.getElementById('timer');
    const form = document.getElementById('writeForm');

    const countdown = setInterval(() => {
        time--;
        timerEl.textContent = time;
        if (time <= 0) {
            clearInterval(countdown);
            form.submit(); // or lock input and wait for server redirect
        }
    }, 1000);

    socket.on("start-turn", ({ turn, endsIn }) => {
        window.location.href = `/games/story/${code}/write?turn=${turn}&username=${username}`;
    });

    socket.on("game-finished", () => {
        window.location.href = `/games/story/${code}/results`;
    });
</script>