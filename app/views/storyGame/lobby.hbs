<h1>Story Game Lobby</h1>

<p class="story-meta">Room Code: <strong>{{code}}</strong></p>
<h3>Invite Players</h3>
<p class="story-meta">
    Share this link to invite others:
    <input id="lobby-link" type="text" value="{{{joinUrl}}}" readonly style="width: 100%; max-width: 500px;">
</p>

<h2>Players</h2>
<ul id="player-list">
    {{#each room.players}}
    <li>{{this.name}}</li>
    {{/each}}
</ul>

{{#if (eq room.host username)}}
<form id="start-form" action="/games/story/{{code}}/start" method="POST">
    <label>Turn Time (seconds):
        <input type="number" name="turnTime" value="{{room.settings.turnTime}}" min="10" />
    </label>
    <label style="display:block;margin-top:8px;">
        <input type="checkbox" name="keepHistory" {{#if room.settings.keepHistory}}checked{{/if}} /> Enable view
        individual submissions
    </label>
    <fieldset style="margin-top:8px;">
        <legend>Reading Phase</legend>
        <label>
            <input type="checkbox" name="enableReadingPhase" {{#if room.settings.enableReadingPhase}}checked{{/if}} />
            Enable reading phase
        </label>
        <label style="display:block;margin-top:4px;">Reading Time (seconds):
            <input type="number" name="readingPhaseTime" value="{{room.settings.readingPhaseTime}}" min="5" />
        </label>
    </fieldset>
    <button type="submit">Start Game</button>
</form>
{{else}}
<p class="story-meta">Waiting for <strong>{{room.host}}</strong> to start the game...</p>
{{/if}}

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const code = "{{code}}";
    const username = "{{username}}";
    socket.emit('join-room', code);

    socket.on('player-joined', (players) => {
        const list = document.getElementById('player-list');
        list.innerHTML = '';
        players.forEach(p => {
            const li = document.createElement('li');
            li.textContent = p.name;
            list.appendChild(li);
        });
    });

    socket.on('game-started', () => {
        window.location.href = `/games/story/${code}/write?turn=0&username=${encodeURIComponent(username)}`;
    });

    socket.on("start-turn", ({ turn, endsIn }) => {
        window.location.href = `/games/story/${code}/write?turn=${turn}&username=${encodeURIComponent(username)}`;
    });

    socket.on("game-finished", () => {
        window.location.href = `/games/story/${code}/results?username=${encodeURIComponent(username)}`;
    });
</script>
